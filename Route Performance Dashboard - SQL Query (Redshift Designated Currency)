SELECT 
NF.airlineiatacode,
NF.farenetdate,
NF.departureairportiatacode,
NF.arrivalairportiatacode,
NF.flighttype,
NF.siteedition,
NF.searches,
NF.averagepriceusd,
NC.conversions,
NC.revenue,
CC.avg_exchangerate
FROM

            (SELECT DISTINCT
             UPPER(airlineiatacode) as airlineiatacode,
             farenettimestamp::DATE as farenetdate,
             departureairportiatacode,
             arrivalairportiatacode,
             journeytype,
             departuredate,
             returndate,
             outboundfareclass,
             inboundfareclass,
             flighttype,
             siteedition,
             COUNT(DISTINCT farenetid) AS searches,
             AVG(totalpriceusd) AS averagepriceusd
             FROM datacore.public.normalized_farenet_001
             WHERE "__createdat" >= '2021-02-18'::TIMESTAMP AND "__createdat" < current_date ::TIMESTAMP 
             AND farenetdate >= DATE('2021-02-18') AND farenetdate < current_date
             AND UPPER(airlineiatacode) ='XX'
             AND isusersearch = TRUE
             GROUP BY "airlineiatacode", "farenetdate", departureairportiatacode, arrivalairportiatacode,
                  journeytype, departuredate, returndate, outboundfareclass, inboundfareclass, flighttype,siteedition
             ) NF
             
LEFT JOIN
            (SELECT DISTINCT 
             UPPER(airlineiatacode)   AS "nc_airlineiatacode",
             farenetconfirmationtimestamp::DATE  AS "nc_farenetconfirmationdate",
             departureairportiatacode AS "nc_departureairportiatacode",
             arrivalairportiatacode   AS "nc_arrivalairportiatacode",
             journeytype              AS "nc_journeytype",
             departuredate            AS "nc_departuredate",
             returndate               AS "nc_returndate",
             outboundfareclass        AS "nc_outboundfareclass",
             inboundfareclass         AS "nc_inboundfareclass",
             flighttype              AS "nc_flighttype",
             COUNT(DISTINCT farenetconfirmationid)            AS conversions,
             sum(totalpriceusd)             AS revenue
              FROM datacore.public.normalized_farenet_confirmation_001
              WHERE "__createdat" >= '2021-02-18'::TIMESTAMP AND "__createdat" < current_date ::TIMESTAMP 
                AND "nc_farenetconfirmationdate" >= DATE('2021-02-18') AND "nc_farenetconfirmationdate" < current_date
                AND UPPER(airlineiatacode) ='XX'
              GROUP BY "nc_airlineiatacode", "nc_farenetconfirmationdate", "nc_departureairportiatacode", "nc_arrivalairportiatacode",
                  "nc_journeytype", "nc_departuredate", "nc_returndate", "nc_outboundfareclass", "nc_inboundfareclass", "nc_flighttype"
                 ) NC
                 
                 ON (NF.airlineiatacode = NC.nc_airlineiatacode
                 AND NF.farenetdate = NC."nc_farenetconfirmationdate"
                 AND NF.departureairportiatacode =NC.nc_departureairportiatacode
                 AND NF.arrivalairportiatacode = NC.nc_arrivalairportiatacode
                 AND NF.journeytype = NC.nc_journeytype
                 AND NF.departuredate = NC.nc_departuredate
                 AND (NF.returndate = NC.nc_returndate
                     OR NC.nc_returndate is null)
                 AND NF.outboundfareclass = NC.nc_outboundfareclass
                 AND (NF.inboundfareclass = NC.nc_inboundfareclass
                     OR NC.nc_inboundfareclass is null))
                     
LEFT JOIN 
             (SELECT DISTINCT
              farenettimestamp::DATE AS "Search Date_Currency",
              currencycode as currency,
              avg(exchangerate) as avg_exchangerate 
              FROM datacore.public.normalized_farenet_001
              WHERE 
              __createdat >= '2021-02-18'::TIMESTAMP --change the date to the starting date of this airline in Farenet.
              AND upper(airlineiatacode)='XX' --change the airlineIataCode here.
              AND upper(currencycode)='CAD' --change the currency code here.
              and isusersearch = TRUE --Enable this line if the starting date is after 08/2019.
              GROUP BY "Search Date_Currency",currency) CC 
              
              ON NF.farenetdate = CC."Search Date_Currency"

--JOIN datacore.custom.latest_core_dictionary CDLD on NF.departureairportiatacode = CDLD.iatacode
--JOIN  datacore.custom.latest_core_dictionary CDLA on NF.arrivalairportiatacode = CDLA.iatacode
